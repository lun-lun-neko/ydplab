name: Deploy React to GitHub Pages (develop)

on:
  push:
    branches: [ develop ]   # âœ… developì— pushë  ë•Œë§ˆë‹¤ ë°°í¬
  workflow_dispatch:        # ìˆ˜ë™ ì‹¤í–‰ë„ í—ˆìš©

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Build
        env:
          # CRA ê²½ê³ ë¡œ ì‹¤íŒ¨ ë°©ì§€ (Viteë©´ ìˆì–´ë„ ë¬´ë°©)
          CI: false
          # í° ë²ˆë“¤ ëŒ€ë¹„(ì„ íƒ)
          NODE_OPTIONS: --max-old-space-size=4096
        run: npm run build

      - name: Show top-level folders (debug)
        run: ls -la

      # build / dist / out / public ì•ˆì—ì„œ index.html ìˆëŠ” ê²½ë¡œ ìë™ íƒì§€
      - name: Detect static output directory
        id: detect
        run: |
          set -e
          PUBLISH_DIR=""
          for d in build dist out public; do
            if [ -f "$d/index.html" ]; then
              PUBLISH_DIR="$d"
              break
            fi
          done
          if [ -z "$PUBLISH_DIR" ]; then
            echo "âŒ No index.html found in build/dist/out/public."
            echo "Folders (depth 2) for debugging:"
            find . -maxdepth 2 -type d -print
            exit 1
          fi
          echo "publish_dir=$PUBLISH_DIR" >> "$GITHUB_OUTPUT"
          echo "âœ… Using $PUBLISH_DIR"

      - name: Show detected dir (debug)
        run: ls -la "${{ steps.detect.outputs.publish_dir }}"

      # SPA ë¼ìš°íŒ… 404 ë°©ì§€
      - name: Add 404 fallback for SPA
        run: cp "${{ steps.detect.outputs.publish_dir }}/index.html" "${{ steps.detect.outputs.publish_dir }}/404.html"

      # ğŸ‘‰ ë°˜ë“œì‹œ ê°ì§€ëœ ê²½ë¡œë¡œ ì—…ë¡œë“œ!
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ steps.detect.outputs.publish_dir }}

  deploy:
    if: github.ref == 'refs/heads/develop'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
# name: Deploy React to GitHub Pages

# on:
#   push:
#     branches: [ main ]   # ê¸°ë³¸ ë¸Œëœì¹˜ì— ë§ê²Œ ìˆ˜ì •
#   workflow_dispatch:

# permissions:
#   contents: read
#   pages: write
#   id-token: write

# concurrency:
#   group: "pages"
#   cancel-in-progress: true

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Node
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20
#           cache: npm

#       - name: Install dependencies
#         run: |
#           if [ -f package-lock.json ]; then npm ci; else npm install; fi

#       - name: Build
#         env:
#           CI: false   # CRA ê²½ê³ ë¡œ ì‹¤íŒ¨ ë°©ì§€
#         run: npm run build

#       - name: Show top-level folders (debug)
#         run: ls -la

#       # build / dist / out / public ì•ˆì—ì„œ index.html ìˆëŠ” ê²½ë¡œ ìë™ íƒì§€
#       - name: Detect static output directory
#         id: detect
#         run: |
#           set -e
#           PUBLISH_DIR=""
#           for d in build dist out public; do
#             if [ -f "$d/index.html" ]; then
#               PUBLISH_DIR="$d"
#               break
#             fi
#           done

#           if [ -z "$PUBLISH_DIR" ]; then
#             echo "âŒ No index.html found in build/dist/out/public."
#             echo "Folders (depth 2) for debugging:"
#             find . -maxdepth 2 -type d -print
#             exit 1
#           fi

#           echo "publish_dir=$PUBLISH_DIR" >> "$GITHUB_OUTPUT"
#           echo "âœ… Using $PUBLISH_DIR"

#       - name: Show detected dir (debug)
#         run: ls -la "${{ steps.detect.outputs.publish_dir }}"

#       # SPA ë¼ìš°íŒ… 404 ë°©ì§€
#       - name: Add 404 fallback for SPA
#         run: cp "${{ steps.detect.outputs.publish_dir }}/index.html" "${{ steps.detect.outputs.publish_dir }}/404.html"

#       # ğŸ‘‰ ë°˜ë“œì‹œ ê°ì§€ëœ ê²½ë¡œë¡œ ì—…ë¡œë“œ!
#       - name: Upload Pages artifact
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: ${{ steps.detect.outputs.publish_dir }}

#   deploy:
#     needs: build
#     runs-on: ubuntu-latest
#     environment:
#       name: github-pages
#       url: ${{ steps.deployment.outputs.page_url }}
#     steps:
#       - name: Deploy to GitHub Pages
#         id: deployment
#         uses: actions/deploy-pages@v4

